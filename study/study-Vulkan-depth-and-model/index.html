<!DOCTYPE html>
<!--
    So Simple Jekyll Theme 3.2.0
    Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
    Free for personal and commercial use under the MIT license
    https://github.com/mmistakes/so-simple-theme/blob/master/LICENSE
--><html lang="en-US" class="no-js">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  

  
  
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Vulkan Tutorial - Depth buffering &amp; Loding models | KC blog</title>
<meta name="generator" content="Jekyll v3.9.5">
<meta property="og:title" content="Vulkan Tutorial - Depth buffering &amp; Loding models">
<meta property="og:locale" content="en_US">
<meta name="description" content="이전 little vulakn game engine tutorial 을 따라오면서 대부분 이미 작성했던 내용들. 가볍게 강조할 것들만 정리해놓고자 함.">
<meta property="og:description" content="이전 little vulakn game engine tutorial 을 따라오면서 대부분 이미 작성했던 내용들. 가볍게 강조할 것들만 정리해놓고자 함.">
<link rel="canonical" href="https://keechang-choi.github.io/study/study-Vulkan-depth-and-model/">
<meta property="og:url" content="https://keechang-choi.github.io/study/study-Vulkan-depth-and-model/">
<meta property="og:site_name" content="KC blog">
<meta property="og:image" content="https://keechang-choi.github.io/images/vulkan-tutorial-depth.png">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-05-11T00:00:00+09:00">
<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:image" content="https://keechang-choi.github.io/images/vulkan-tutorial-depth.png">
<meta property="twitter:title" content="Vulkan Tutorial - Depth buffering &amp; Loding models">
<meta name="twitter:site" content="@">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-11T00:00:00+09:00","datePublished":"2023-05-11T00:00:00+09:00","description":"이전 little vulakn game engine tutorial 을 따라오면서 대부분 이미 작성했던 내용들. 가볍게 강조할 것들만 정리해놓고자 함.","headline":"Vulkan Tutorial - Depth buffering &amp; Loding models","image":{"thumbnail":"/images/vulkan-tutorial-depth.png","url":"https://keechang-choi.github.io/images/vulkan-tutorial-depth.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://keechang-choi.github.io/study/study-Vulkan-depth-and-model/"},"url":"https://keechang-choi.github.io/study/study-Vulkan-depth-and-model/"}</script>
<!-- End Jekyll SEO tag -->


  

  <script>
    /* Cut the mustard */
    if ('querySelector' in document && 'addEventListener' in window) {
      document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + 'js';
    }
  </script>

  <link href="/assets/leaf-48.ico" rel="shortcut icon" type="image/vnd.microsoft.icon">

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/skins/default.css">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i|Lora:400,400i,700,700i">
  <link rel="alternate" type="application/atom+xml" title="KC blog" href="/atom.xml">
<!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

</head>

  <body class="layout--post  vulkan-tutorial-depth-buffering-loding-models">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#primary-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    
  <div class="navigation-wrapper">
    <a href="#menu-toggle" id="menu-toggle">Menu</a>
    <nav id="primary-nav" class="site-nav animated drop">
      <ul>
<li><a href="/">Home</a></li>
<li><a href="/posts/">Posts</a></li>
<li><a href="/categories/">Categories</a></li>
<li><a href="/tags/">Tags</a></li>
<li><a href="/search/">Search</a></li>
</ul>
    </nav>
  </div>
<!-- /.navigation-wrapper -->


    <header class="masthead">
  <div class="wrap">
    
    
    
  </div>
</header><!-- /.masthead -->


    <main id="main" class="main-content" aria-label="Content">
  <article class="h-entry">
    
  
  
  

  <div class="page-image">
    <img src="/images/vulkan-tutorial-depth.png" class="entry-feature-image u-photo" alt="Vulkan Tutorial - Depth buffering &amp; Loding models" style="margin-top: 0;">
    
  </div>


    <div class="page-wrapper">
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <header class="page-header">
        
        
        <h1 id="page-title" class="page-title p-name">Vulkan Tutorial - Depth buffering &amp; Loding models
</h1>
        
      </header>

      <div class="page-sidebar">
        <div class="page-author h-card p-author">
<div class="author-info">
<ul class="author-links"><li class="author-link">
            <a class="u-url" rel="me" href=""><i class="fas fa-link fa-lg" title=""></i></a>
          </li></ul>
    <time class="page-date dt-published" datetime="2023-05-11T00:00:00+09:00"><a class="u-url" href="">May 11, 2023</a>
</time>

  </div>
</div>

        
  <h3 class="page-taxonomies-title">Categories</h3>
  
  <ul class="page-taxonomies">
<li class="page-taxonomy"><a class="p-category" href="/categories/#study" title="Pages filed under study">study</a></li>
  </ul>


        
  <h3 class="page-taxonomies-title">Tags</h3>
  
  <ul class="page-taxonomies">
<li class="page-taxonomy"><a href="/tags/#graphics" title="Pages tagged graphics" rel="tag">graphics</a></li>
  </ul>


      </div>

      <div class="page-content">
        <div class="e-content">
          <p>이전 little vulakn game engine tutorial 을 따라오면서 대부분 이미 작성했던 내용들.
가볍게 강조할 것들만 정리해놓고자 함.</p>

<ul>
  <li>
<a href="#depth-buffering">Depth buffering</a>
    <ul>
      <li><a href="#intro">Intro</a></li>
      <li><a href="#3d-geometry">3D geometry</a></li>
      <li><a href="#depth-image-and-view">Depth image and view</a></li>
      <li><a href="#explicitly-transitioning-the-deoth-image">Explicitly transitioning the deoth image</a></li>
      <li>
<a href="#render-pass">Render pass</a>
        <ul>
          <li><a href="#subpass-">subPass ?</a></li>
        </ul>
      </li>
      <li><a href="#frame-buffer">Frame buffer</a></li>
      <li><a href="#clear-values">Clear values</a></li>
      <li><a href="#depth-and-stencil-state">Depth and stencil state</a></li>
      <li><a href="#handling-window-size">Handling window size</a></li>
    </ul>
  </li>
  <li>
<a href="#loading-models">Loading models</a>
    <ul>
      <li><a href="#intro-1">Intro</a></li>
      <li><a href="#library">Library</a></li>
      <li><a href="#sample-mesh">Sample mesh</a></li>
      <li><a href="#loading-vertices-and-indices">Loading vertices and indices</a></li>
      <li><a href="#vertex-deduplication">Vertex deduplication</a></li>
    </ul>
  </li>
</ul>

<hr>

<h1 id="depth-buffering">Depth buffering</h1>
<p><a href="https://vulkan-tutorial.com/Depth_buffering">vulkan-tutorial.com 해당 내용</a></p>

<p><img src="/images/vulkan-tutorial-depth.png" alt="image"></p>

<h2 id="intro">Intro</h2>
<p>이전에 사과 모델을 띄웠을때, 위 이미지처럼 face들이 가까운 것과 먼것에 대한 처리 없이 나왔어야 하지만, 이전 과정<a href="https://youtu.be/ecMcXW6MSYU?list=PL8327DO66nu9qYVKLDmdLW_84-yE4auCR">(Fixed Function Pipeline Stages -Vulkan Game Engine Tutorial 04)</a>에서 이미 depth test에 대한 처리가 구현되어 있어 잘 나올 수 있었다.<br>
depth test란 간단히 현 시점 기준 보이는 가까운 것은 그리고 가려지는 먼 것은 그리지 않게 하기위한 테스트이다.</p>

<h2 id="3d-geometry">3D geometry</h2>
<p>vulkan-tutorial.com/Depth_buffering 의 내용에서는 이전 texture 내용을 2d flat 사각형에 그렸기 때문에 2d vertex 을 사용했었다.</p>

<p><a href="https://www.youtube.com/watch?v=0X_kRtyVzm4&list=PL8327DO66nu9qYVKLDmdLW_84-yE4auCR&index=14">Euler Angles &amp; Homogeneous Coordinates - Vulkan Game Engine Tutorial 12</a> 에 해당하는 내용이며, 다음 세가지를 2D에서 3D에 맞게 변경하는 내용이다.</p>
<ul>
  <li>attribhuteDescription에서 3으로 바꿔줘야 함.</li>
  <li>vertex shader</li>
  <li>model vertices</li>
</ul>

<p>이 단계를 마치고 렌더링 했을 때, 위와 같은 앞뒤가 뒤죽박죽인 화면을 얻을 수 있다.</p>

<p>depth 처리를 위한 두가지 방법을 소개하는데,</p>
<ul>
  <li>draw call 순서를 조정</li>
  <li>depth test를 사용 (depth buffer)</li>
</ul>

<p>1번 방법은 투명한 물체 표현에 사용된다. order independent transparency는 해결하기 힘든 문제라고 하는데, 그래서 이전의 point light 의 semi-transparent 구현에서도 alpha blending과 order dependent한 방식으로 해결했다. <a href="https://www.youtube.com/watch?v=uZqxj6tLDY4&list=PL8327DO66nu9qYVKLDmdLW_84-yE4auCR&index=31">Alpha Blending and Transparency - Vulkan Game EngineTutorial 27</a></p>

<p>여기서는 2번 방법에 대한 구현이 진행된다. 원리는 rasterizer 단계에서 fragment를 생성할때마다, depth test를 실행해서 새로운 fragment가 이전 것 보다 가까운지 depth 값을 비교해서 가까운 것만 저장하는 방식이다.</p>

<p>주의할 점은 OpenGL에서는 -1 ~ 1 이 기본 depth 범위이지만, Vulkan에서는 0 ~ 1 이기에 변경을 해줘야 한다.</p>

<h2 id="depth-image-and-view">Depth image and view</h2>

<p>depth data도 image기반이며, swap chain 생성시 명시적으로 생성을 해줘야 한다.<br>
기존 image 생성 처럼 다음 세가지를 생성해야한다.</p>
<ul>
  <li>image</li>
  <li>memory</li>
  <li>image view</li>
</ul>

<p>stencil component가 있는데, stencil test에 사용된다고 한다. 아직 다루지 않아서 넘어가려하는데, potal rendering 등에 쓰일 수 있다고 한다. <a href="https://en.wikipedia.org/wiki/Stencil_buffer">https://en.wikipedia.org/wiki/Stencil_buffer</a></p>

<p>그리고 이 stencil buffer를 사용할 경우 image format이 달라지기 때문에 유의.</p>

<h2 id="explicitly-transitioning-the-deoth-image">Explicitly transitioning the deoth image</h2>

<p>render pass에서 image layout을 depth attachment로 transition해주기 때문에 명시적으로 작성할 필요 없다고 한다. 하지만 안내대로 추가해주었다. (실수로 잘못 추가하면 validation layer warning을 보게된다.)</p>

<p>아직 render pass나 compatibility 개념에 대해 잘 모르는 부분이 많아서 관련 문서를 나중에 읽어봐야겠다.<br>
<a href="https://registry.khronos.org/vulkan/specs/1.1-extensions/html/chap8.html#renderpass-compatibility">Vulkan® 1.1.249 - A Specification (with all registered Vulkan extensions) (khronos.org)</a></p>

<p>만들어 놓은 depth 관련 자원들은 frame buffer 생성시 attachment를 통해 설정된다.</p>

<p>stage관련,  depth buffer reading은 early fragment test stage(rasterization 이후, fragment shader 이전 단계)에서 일어나고, writing(새로운 fragment가 test통과 후 그려질때 write)은 late fragment test stage에서 일어난다고 한다. transition의 dst stage는 당연하게 둘 중 더 이른 것으로 설정했다.</p>

<h2 id="render-pass">Render pass</h2>

<p>depth attachment description을 설정해야 한다.
renderPass가 pipeline의 청사진 같은 개념이기에 실제 들어올 데이터와 같은 format을 명시해줘야 한다.</p>

<ul>
  <li>format : depth image foramt과 동일하게</li>
  <li>attachment load op : clear 사용 (clear value도 변경해줘야 함)</li>
  <li>store op : dont care로 지정해서 하드웨어 차원에서 최적화 할 수 있도록 둔다.</li>
  <li>init layout / final layout : transition에서 명시해준 layout 들이 여기서 지정해줬기 때문에 불필요했던 것 같은데 render pass 관련 개념을 좀 더 알게되면 보충하겠다.</li>
</ul>

<h3 id="subpass-">subPass ?</h3>
<p>기존에 있던 subPass의 color attachment에 추가로 depth attachment를 추가해준다. subpass에 대해서 다루진 않았던 것 같아서 skip한 내용을 좀 더 찾아봤다. <a href="https://vulkan-tutorial.com/Drawing_a_triangle/Graphics_pipeline_basics/Render_passes">https://vulkan-tutorial.com/Drawing_a_triangle/Graphics_pipeline_basics/Render_passes</a></p>

<ul>
  <li>하나의 renderPass는 여러개의 subPass로 이뤄질 수 있다.</li>
  <li>subPass는 뒤따라오는 렌더링 연산인데, 이전 패스들의 frame buffer 내용에 의존한다.
    <ul>
      <li>예를 들어 post-processing 효과들의 sequence</li>
      <li>이런 연산들을 하나의 renderPass에 묶으면 좋은점이, vulkan이 알아서 순서를 바꿔서 메모리 bandwidth를 conserve해서 성능을 높여준다고 한다.</li>
    </ul>
  </li>
  <li>각 subPass는 하나 이상의 attachment를 참조한다.</li>
  <li>attachment reference의 attachment 설정으로 shader의 location과 연결지어준다.</li>
  <li>다른 attachment 예시들
    <ul>
      <li>pInputAttachments : shader에서 읽을 것</li>
      <li>pResolveAttachments:  color att의 Multi Sampling에 사용될 것</li>
      <li>pDepthStencilAttachment: depth와 stencil</li>
      <li>pPreserveAttachments: 이 subpass에서 사용안되지만 보존되어야 할 데이터</li>
      <li>등등</li>
    </ul>
  </li>
</ul>

<p>기존 하나 있던 subPass의 color attachment는 여러개가 가능하지만 depth는 하나의 attachment만 가능하다고 한다.</p>

<p>dependency와 이를 사용할 renderPassInfo를 수정해준다.</p>
<ul>
  <li>dependency mask에는 stage와 access 지정을 하는데, early fragment test stage와 write access로 지정을 해준다</li>
  <li>clear를 하는 load operation이 있기때문에 write로 지정해줘야 한다.</li>
</ul>

<h2 id="frame-buffer">Frame buffer</h2>

<p>만들어둔 depth image view를 attachment에 추가해준다.</p>

<p>지금 구현상태와 차이점이 있는데, color attachment는 swap chain image마다 다르지만, depth image는 공용으로 쓰일 수 있다고 한다.
subpass가 하나여서 그렇다고 하는데, 지금 구현에서는 color와 마찬가지로 in-flight image 수 만큼 나눠져 있다. 추후 추가할 부분을 고려해서 나눠놓은 것인지 모르겠으나 좀 더 살펴볼 필요가 있어보인다.</p>

<h2 id="clear-values">Clear values</h2>

<p>현재 구현 코드에서는 <code class="language-plaintext highlighter-rouge">beginSwapChainRenderPass</code>에 구현된 내용이며, clear value로 color에 추가로 depth,stencil 초기값을 지정해준다.
vulkan에서 가까운 depth value가 0.0f이고 먼 값이 1.0f이기에 초기값은 1.0f로 지정해주는 것에 유의.<br>
clear value 순서도 당연하게 attachment index와 일치해야 한다. (*color : 0, depthStencil : 1)</p>

<h2 id="depth-and-stencil-state">Depth and stencil state</h2>

<p>이제 depth attachment를 사용할 준비가 끝났다.<br>
pipeline 생성시 config에 depth test enable 등 사용 설정을 명시한다.</p>
<ul>
  <li>depthTestEnable</li>
  <li>depthWriteEnable</li>
  <li>depthCompareOp</li>
  <li>depthBoundsTestEnable</li>
  <li>stecil buffer 관련은 우선 안씀</li>
</ul>

<p>맨 위의 이미지는 이 설정을 꺼놓고 실행시켜 재현했다.</p>

<h2 id="handling-window-size">Handling window size</h2>

<p>swap chain recreate시, 변경된 화면 extent등을 맞게 depth 자원도 새로 재생성해줘야 한다</p>

<h1 id="loading-models">Loading models</h1>
<p><img src="/images/vulkan-tutorial-loading.png" alt="image"></p>

<h2 id="intro-1">Intro</h2>
<p>저장된 model file에서 읽어오는 것
이미 <a href="https://www.youtube.com/watch?v=jdiPVfIHmEA&list=PL8327DO66nu9qYVKLDmdLW_84-yE4auCR&index=20">Loading 3D Models - Vulkan Game Engine Tutorial 17</a> 에서 동일한 내용을 다뤘다.</p>

<h2 id="library">Library</h2>

<p>tiny obj loader 사용
직접 loader를 간단히 만들어도 되지만, 어차피 실용적인것이 아니라서 불러온 데이터를 활용하는 것에 집중한다.</p>

<h2 id="sample-mesh">Sample mesh</h2>

<p><a href="https://sketchfab.com/">Sketchfab</a> 사이트에서 모델을 찾기 좋다고 한다.<br>
tutorial과 동일한 viking room 모델을 사용했다.</p>

<h2 id="loading-vertices-and-indices">Loading vertices and indices</h2>

<p><code class="language-plaintext highlighter-rouge">vkCmdBindIndexBuffer</code> 시 index type을 명시해주는데, 이전에 65535개 보다 작았어서 <code class="language-plaintext highlighter-rouge">uint16_t</code> 를 사용하던 것에서 <code class="language-plaintext highlighter-rouge">uint32_t</code>로 변경해준다.</p>

<p>obj file의 face를 통해서 vertices reuse가 가능하다.</p>

<p><code class="language-plaintext highlighter-rouge">tinyobj::LoadObj</code> 에서는 기본으로 <code class="language-plaintext highlighter-rouge">triangulate</code> arg가 true로 되어 있는데, obj file format은 삼각형 face이외의 도형도 가능하긴 하지만 우리는 삼각형만 사용.</p>

<ul>
  <li>각 face는 vertices array를 포함</li>
  <li>각 vertex는 (position, normal, texture)의 indices를 포함</li>
  <li>material과 texture per face도 포함할 수 있으나 우선 안씀.</li>
</ul>

<p>모델의 vertices 수가 많아짐에 따라 컴파일 시 -O3 옵션 또눈 Release 모드를 사용하라고 한다.</p>

<p>texture coordinate을 읽을 때, obj format 과 vulkan format의 vertical 이 반대인 것 유의. 
obj에서 0은 이미지의 bottom, vulkan에서의 0은 이미지의 top.</p>

<h2 id="vertex-deduplication">Vertex deduplication</h2>

<p>모델의 vertices 자체에 중복이 많다면 index buffer의 장점을 살리지 못할 수 있다.<br>
이런 경우를 위해서 hash map을 활용한 중복 제거를 추가한다.</p>

<p>이때 hash에는, position, color, normal, uv의 vector들을 combine해야 하는데, 이 문제가 간단하지 않다고 한다.</p>

<p>이 문제가 아직 완벽한 solution이 있는게 아니라서 c++ 공식 버전에 포함되지 않은 것이라는 말도 있던데, tutorial에서는 <a href="https://en.cppreference.com/w/cpp/utility/hash">cppreference.com</a>의 예시 방식을 추천하지만 우리 구현은 <a href="https://stackoverflow.com/questions/2590677">https://stackoverflow.com/questions/2590677</a>(boost 구현 방식)을 참고하여 구현되어 있다. <br>
애초에 boost lib의 많은 기능들이 c++ standard로 추후에 포함되곤 하니 신뢰할 순 있을 것 같다.</p>

<hr>
<p>boost 에서 쓰고 있는 magic number? (<code class="language-plaintext highlighter-rouge">0x9e3779b9</code>) 방식과 xor 방식의 차이인 것 같은데 이 hash combine 내용만 한번 따로 다뤄봐도 재밌겠다고 생각이 들었다.<br>
그나저나 effective c++ / effective modern c++ 책을 사놓고 잘 안읽고 있는데 틈틈이 봐야겠다.</p>

        </div>

        

        

        <script src="https://utteranc.es/client.js" repo="keechang-choi/keechang-choi.github.io" issue-term="pathname" theme="github-light" label="Comment" crossorigin="anonymous" async>
          </script>

        <nav class="page-pagination" role="navigation">
  
    <a class="page-previous" href="/study/study-Vulkan-texture/">
      <h4 class="page-pagination-label">Previous</h4>
      <span class="page-pagination-title">
        <i class="fas fa-arrow-left"></i> Vulkan Tutorial - Texture

      </span>
    </a>
  

  
    <a class="page-next" href="/study/study-Vulkan-mipmap-multisampling/">
      <h4 class="page-pagination-label">Next</h4>
      <span class="page-pagination-title">
        Vulkan Tutorial - Generating mipmaps &amp; MultiSampling
 <i class="fas fa-arrow-right"></i>
      </span>
    </a>
  
</nav>

      </div>
    </div>
  </article>
</main>

    <footer id="footer" class="site-footer">
  <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
<div class="social-icons"><a class="social-icon" href="/atom.xml"><i class="fas fa-rss-square fa-2x" title="Feed"></i></a></div>
<div class="copyright">
    
      <p>© 2024 KC blog. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/mmistakes/so-simple-theme" rel="nofollow">So Simple</a>.</p>
    
  </div>
</footer>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.12/js/all.js"></script>


<!-- MathJax -->

<script>
// http://docs.mathjax.org/en/latest/upgrading/v2.html
MathJax = {
  tex: {
      tags: "ams"    // eq numbering options: none, ams, all
  },
  options: {
    renderActions: {
      // for mathjax 3, handle <script "math/tex"> blocks inserted by kramdown
      find: [10, function (doc) {
        for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
          const display = !!node.type.match(/; *mode=display/);
          const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
          const text = document.createTextNode('');
          node.parentNode.replaceChild(text, node);
          math.start = {node: text, delim: '', n: 0};
          math.end = {node: text, delim: '', n: 0};
          doc.math.push(math);
        }
      }, '']
    }
  }
}
</script>

<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  </body>

</html>
